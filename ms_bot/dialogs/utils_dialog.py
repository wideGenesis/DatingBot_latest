from botbuilder.core import ConversationState, MessageFactory, CardFactory, UserState
from botbuilder.dialogs import (
    ComponentDialog,
    WaterfallDialog,
    WaterfallStepContext,
    DialogTurnResult,
    PromptOptions,
    TextPrompt, ChoicePrompt
)
from botbuilder.schema import HeroCard, CardAction, ActionTypes, InputHints
from ms_bot.bots_models.models import CustomerProfile

from settings.logger import CustomLogger


logger = CustomLogger.get_logger('bot')


class UtilsDialog(ComponentDialog):
    def __init__(
            self,
            conversation_state: ConversationState,
            user_state: UserState,
            dialog_id: str = None
    ):
        super(UtilsDialog, self).__init__(dialog_id or UtilsDialog.__name__)

        self.user_state = user_state
        self.user_profile_accessor = self.user_state.create_property("CustomerProfile")

        self.add_dialog(ChoicePrompt(ChoicePrompt.__name__))
        self.add_dialog(TextPrompt(TextPrompt.__name__))
        self.add_dialog(
            WaterfallDialog(
                "UtilsDialog",
                [
                    self.bot_input,
                    self.integrity_check,
                    self.customer_prompt,
                    self.customer_search
                ]
            )
        )

        self.initial_dialog_id = "UtilsDialog"
        self.conversation_state = conversation_state

    async def bot_input(self, step_context: WaterfallStepContext) -> DialogTurnResult:
        logger.debug('bot_input %s', UtilsDialog.__name__)
        user_data: CustomerProfile = await self.user_profile_accessor.get(step_context.context, CustomerProfile)
        activity_ids = []
        prompt_text = MessageFactory.list([])
        prompt_text.attachments.append(self._create_hero_card())

        resource_response = await step_context.context.send_activity(prompt_text)
        activity_ids.append(resource_response.id)

        user_data.activity_ids = activity_ids

        prompt_message = MessageFactory.text('‚è≥', InputHints.expecting_input)
        return await step_context.prompt(TextPrompt.__name__, PromptOptions(prompt=prompt_message))

    async def integrity_check(self, step_context: WaterfallStepContext) -> DialogTurnResult:
        logger.debug('integrity_check %s', UtilsDialog.__name__)
        user_data: CustomerProfile = await self.user_profile_accessor.get(step_context.context, CustomerProfile)

        found_choice = step_context.result

        for activity_id in user_data.activity_ids:
            await step_context.context.delete_activity(activity_id)

        if found_choice == '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–¥':
            result = await _count_all()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–æ—Ç—ñ':
            result = await _count_reg()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω–∏—Ö –≥–µ–æ':
            result = await _count_broadcast_geo()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –≥–µ–æ':
            result = await _count_replies_received()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == '–¢—ñ, —Ö—Ç–æ –≤–∏–¥–∞–ª–∏–ª–∏ –±–æ—Ç–∞':
            result = await _search_banned()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == '–ü–æ—à—É–∫ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞':
            return await step_context.next([])

        elif found_choice == '‚ù§Ô∏è Response time':
            result = ping_message()
            await step_context.context.send_activity(result)
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == 'üóë –í–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –∑–∞–ø–∏—Å':
            await _self_delete(self.conversation_state, step_context)
            await step_context.context.send_activity('–í–∏–¥–∞–ª–µ–Ω–æ')
            return await step_context.replace_dialog(UtilsDialog.__name__)

        elif found_choice == 'üîô –í–∏—Ö—ñ–¥':
            await step_context.cancel_all_dialogs(True)

        else:
            return await step_context.cancel_all_dialogs(True)

        return await step_context.cancel_all_dialogs(True)

    async def customer_prompt(self, step_context: WaterfallStepContext) -> DialogTurnResult:
        logger.debug('customer_prompt %s', UtilsDialog.__name__)

        prompt_options = PromptOptions(
            prompt=MessageFactory.text('üîç –í–≤–µ–¥—ñ—Ç—å —Ç–∞–±–µ–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (8 —Ü–∏—Ñ—Ä)')
        )
        return await step_context.prompt(TextPrompt.__name__, prompt_options)

    async def customer_search(self, step_context: WaterfallStepContext) -> DialogTurnResult:
        logger.debug('customer_search %s', UtilsDialog.__name__)

        found_choice: str = step_context.result
        if len(found_choice) == 8:
            result = await _search(found_choice)
            await step_context.context.send_activity(result)
        return await step_context.replace_dialog(UtilsDialog.__name__)

    def _create_hero_card(self):
        card = HeroCard(
            text='ü§†',
            buttons=[
                CardAction(
                    type=ActionTypes.im_back,
                    title='–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–¥',
                    value='–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–¥',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–æ—Ç—ñ',
                    value='–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É –±–æ—Ç—ñ',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω–∏—Ö –≥–µ–æ',
                    value='–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω–∏—Ö –≥–µ–æ',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –≥–µ–æ',
                    value='–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –Ω–∞ –≥–µ–æ',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='–¢—ñ, —Ö—Ç–æ –≤–∏–¥–∞–ª–∏–ª–∏ –±–æ—Ç–∞',
                    value='–¢—ñ, —Ö—Ç–æ –≤–∏–¥–∞–ª–∏–ª–∏ –±–æ—Ç–∞',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='–ü–æ—à—É–∫ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞',
                    value='–ü–æ—à—É–∫ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='üóë –í–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –∑–∞–ø–∏—Å',
                    value='üóë –í–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –∑–∞–ø–∏—Å',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='‚ù§Ô∏è Response time',
                    value='‚ù§Ô∏è Response time',
                ),
                CardAction(
                    type=ActionTypes.im_back,
                    title='üîô –í–∏—Ö—ñ–¥',
                    value='üîô –í–∏—Ö—ñ–¥',
                )
            ],
        )
        return CardFactory.hero_card(card)


async def _count_all() -> str:
    from . import Customer
    try:
        customer = Customer.objects.filter(employeeId__isnull=False).count()
    except Exception as e:
        logger.exception('_count_all error')
        customer = 'db error' + str(e)
    return '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + str(customer)


async def _count_reg() -> str:
    from . import Customer
    try:
        customer = Customer.objects.filter(member_id__isnull=False).count()
    except Exception as e:
        logger.exception('_count_reg error')
        customer = 'db error' + str(e)
    return '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—à–µ–¥—à–∏—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞: ' + str(customer)


async def _count_broadcast_geo() -> str:
    from . import Customer
    try:
        customer = Customer.objects.filter(is_current_state_message_send=True).count()
    except Exception as e:
        logger.exception('_count_broadcast_geo error')
        customer = 'db error' + str(e)
    return '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–∏–≤—à–∏—Ö –∑–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ' + str(customer)


async def _count_replies_received() -> str:
    from . import Customer
    try:
        customer = Customer.objects.filter(is_current_state_reply_received=True).count()
    except Exception as e:
        logger.exception('_count_replies_received error')
        customer = 'db error' + str(e)
    return '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç–≤–µ—Ç–∏–≤—à–∏—Ö –Ω–∞ –∑–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ' + str(customer)


async def _search(employeeId: str):
    from v.models import Customer
    try:
        customer = Customer.objects.get(employeeId=employeeId)
    except Exception:
        customer = None

    if customer:
        message = f'Id: {customer.id} \n  \n' \
                  f'employeeId: {customer.employeeId} \n  \n' \
                  f'displayName: {customer.displayName} \n  \n' \
                  f'mobilePhone: {customer.mobilePhone} \n  \n' \
                  f'userPrincipalName: {customer.userPrincipalName} \n  \n' \
                  f'mail: {customer.mail} \n  \n' \
                  f'department: {customer.department} \n  \n' \
                  f'company: {customer.company} \n  \n' \
                  f'company_id: {customer.company_id} \n  \n' \
                  f'country: {customer.country} \n  \n' \
                  f'country_id: {customer.country_id} \n  \n' \
                  f'region: {customer.region} \n  \n' \
                  f'region_id: {customer.region_id} \n  \n' \
                  f'city: {customer.city} \n  \n' \
                  f'city_id: {customer.city_id} \n  \n' \
                  f'operator_displayName: {customer.operator_displayName} \n  \n' \
                  f'member_id: {customer.member_id} \n  \n' \
                  f'is_current_state_message_send: {customer.is_current_state_message_send} \n  \n' \
                  f'is_current_state_reply_received: {customer.is_current_state_reply_received} \n  \n' \
                  f'last_reply_received_at: {customer.last_reply_received_at} \n  \n' \
                  f'created_at: {customer.created_at} \n  \n' \
                  f'updated_at: {customer.updated_at}'
    else:
        message = 'Customer not found'

    return message


async def _search_banned():
    from . import Customer
    try:
        customers = Customer.objects.filter(operator_displayName='bot was banned')
    except Exception:
        logger.exception('DB error while getting filter(operator_displayName=bot was banned)')
        customers = None
    count = customers.count()

    if customers:
        return f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –∑–∞–±–∞–Ω–∏–≤—à–∏—Ö –±–æ—Ç–∞: {count}'
    else:
        return '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —É–¥–∞–ª–∏–≤—à–∏—Ö –±–æ—Ç–∞, –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'


async def _self_delete(
        conversation_state,
        step_context: WaterfallStepContext
) -> bool:
    from . import Customer
    member_id = step_context.context.activity.from_property.id
    result = None
    select_result = None
    conversation_state_result = None

    try:
        await conversation_state.delete(step_context.context)
        conversation_state_result = True
    except Exception:
        logger.exception('conversation_state.delete %s error', member_id)

    try:
        customer = Customer.objects.get(member_id=member_id)
    except Exception:
        logger.exception('Customer.objects.get %s error', member_id)
        customer = None
    try:
        customer.delete()
    except Exception:
        logger.exception('customer.delete() %s error', member_id)

    try:
        customer = Customer.objects.get(member_id=member_id)
    except Exception:
        logger.warning('SELECT AFTER Customer.objects.get %s object not found', member_id)
        select_result = True

    if select_result and conversation_state_result:
        result = True
    else:
        result = False

    if result:
        logger.warning('<<< self >>> %s', result)
        logger.warning('completed for %s', member_id)
    return bool(result)


def ping_message():
    result = get_ping_statistics()

    try:
        now_d = round(result["now"][0], ndigits=2)
    except Exception:
        now_d = 1.00

    try:
        a10_d = round(result["a10"], ndigits=2)
    except Exception:
        a10_d = 10.00

    try:
        a60_d = round(result["a60"], ndigits=2)
    except Exception:
        a60_d = 10.00

    if a10_d <= now_d <= a60_d:
        text = 'üü° –ü–æ–º—ñ—Ä–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'
    elif a10_d <= now_d >= a60_d:
        text = 'üî¥ –í–∏—Å–æ–∫–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'
    elif a10_d >= now_d <= a60_d:
        text = 'üü¢ –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—î'

    else:
        text = '‚ö†Ô∏è –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–µ (Not enough data)'

    now = str(now_d).replace('.', ',')
    a10 = str(a10_d).replace('.', ',')
    a60 = str(a60_d).replace('.', ',')

    message = f'–ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤–∫–∞–∑–∞–Ω–æ —É –º—Å (1 —Å–µ–∫ = 1000 –º—Å) \n  \n' \
              f'–ü–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: {now} –º—Å \n  \n' \
              f'–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞ 10 —Ö–≤: {a10} –º—Å \n  \n' \
              f'–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞ –≥–æ–¥–∏–Ω—É: {a60} –º—Å \n  \n' \
              f'–°—Ç–∞—Ç—É—Å: {text} \n  \n'

    return message
